<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Twokinds 2019-06-16 Omnipoll Results</title>
  <style>
  body { background: #ffffff; font-family: Helvetica neue, roboto; }
  h1 { font-size: 1.2em; }
  p { margin: 5px 0; }
  .legend-mark {
    display: inline-block;
    margin: 0 5px;
    width: 20px;
    height: 20px;
    border-radius: 10px;
    vertical-align: bottom;
  }

  table { margin: 20px auto; border-collapse: collapse; white-space: nowrap; }
  th { border-bottom: 2px solid #000000; }
  th, td { padding: 2px 5px; }

  th::after {
    display: inline-block;
    content: "";
    margin-left: 5px;
    border: 5px solid transparent;
    width: 0;
    height: 0;
    vertical-align: middle;
  }
  .asc::after { margin-top: 2px; margin-bottom: 5px; border-top: 0; border-bottom: 8px solid #000000; }
  .desc::after { margin-top: 4px; margin-bottom: 3px; border-top: 8px solid #000000; border-bottom: 0; }
  th > input { margin-left: 5px; width: 250px; }

  .selected { background-color: #eded91; }

  .suggestion, .position, .index { text-align: right; }
  .position { width: 20px; }
  .index { width: 30px; }
  .votes { text-align: left; }

  td.suggestion .text { display: block; }
  .one-line-wide td.suggestion .text { white-space: nowrap; }
  .one-line-screen td.suggestion .text { white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
  .multiline td.suggestion .text { white-space: normal; }

  .bar {
    display: inline-block;
    margin-right: 5px;
    border-left: 1px solid #000000;
    height: 2em;
    max-height: 19px;
    vertical-align: top;
  }

  .bar, .legend-mark { background-color: #f79646; }
  .winner-voters .bar, .legend-mark.winner-voters { background-color: #1dafe3; }
  .winner-tom .bar, .legend-mark.winner-tom { background-color: #fff545; }
  .winner-tkpolls .bar, .legend-mark.winner-tkpolls { background-color: #c6697a; }
  .filter { background-color: yellow; }

  tbody > tr:hover { background-color: #d86316; color: #ffffff; }
  tbody > tr:hover .bar { background-color: #fbbc79; }
  tbody > tr:hover .filter { color: #000000; }
  tbody > tr.winner-voters:hover .bar { background-color: #20c4ff; }
  tbody > tr.winner-tom:hover .bar { background-color: #ffff90; }
  tbody > tr.winner-tkpolls:hover .bar { background-color: #ff99ab; }
  </style>
  <script src="js/d3.4.13.0.min.js"></script>
</head>
<body>
  <label for="sketch-date">Sketch date:</label>
  <select id="sketch-date">
    <option value="2020-03-08">2020-03-08</option>
    <option value="2020-02-10">2020-02-10</option>
    <option value="2019-12-22">2019-12-22</option>
    <option value="2019-10-20">2019-10-20</option>
    <option value="2019-09-15">2019-09-15</option>
    <option value="2019-08-25">2019-08-25</option>
    <option value="2019-08-11">2019-08-11</option>
    <option value="2019-08-04">2019-08-04</option>
    <option value="2019-06-16">2019-06-16</option>
    <option value="2019-06-09">2019-06-09</option>
    <option value="2019-06-02">2019-06-02</option>
    <option value="2019-05-19">2019-05-19</option>
  </select>
  <label for="view-mode">View mode:</label>
  <select id="view-mode"></select>
  <header>
    <h1>Twokinds <span class="date"></span> Omnipoll Results</h1>
    <p>This is omnipoll results for <a id="patreon-link" href="">Twokinds Sketch Stream</a> from <span class="date"></span>.
    (Unofficial) archive record of stream can be viewed on YouTube:
    <a id="video-link-full" href="">full-length record of stream (<span id="video-duration-full"></span>)</a> or
    <a id="video-link-short" href="">shorter x20 speed up version (<span id="video-duration-short"></span>)</a>.</p>
    <p id="comment"></p>
    <p>Click on table header to toggle column sort mode (ascending, descending or none).</p>
    <p>Click on row to toggle <span class="selected">highlight</span> you choice.</p>
    <p>Filter on suggestion text support syntax <a href="https://developer.mozilla.org/docs/Web/JavaScript/Guide/Regular_Expressions">JavaScript Regular Expression</a>.
    Matched text in suggestion text <span class="filter">highlighted</span>.</p>
    <p>Filter on votes count may be one number, optionally prefixed with <code>=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code> or <code>&gt;=</code>
    to filter on exact match, less than, less or equal than, greatest than or greatest or equal than respectively; without prefixes used filter on exact match.
    Also it may consist of two numbers, delimited by minus sign (<code>-</code>), defining a closed (with included borders) range to match.</p>
    <p>Bar color legend:
    <span class="legend-mark"></span> – ordinal suggestions
    <span class="legend-mark winner-voters"></span> – top votes
    <span class="legend-mark winner-tom"></span> – Tom picks
    <span class="legend-mark winner-tkpolls"></span> – votes from <a href="https://tkpolls.com/results">tkpolls.com</a></p>
  </header>
  <script>
  function filterFunc(filters) {
    var functions = {
      text: function(value) {
        return (new RegExp(this.value, 'ig')).test(value);
      },
      number: function(value) {
        var testValue = this.value.replace(/\s+/g, '');
        var match = /^(?:(\d+)(?:-(\d+))?|(=|>|<|>=|<=)(\d+))$/i.exec(testValue);
        if (match === null) { return false; }

        var low = +match[1];
        var high = +match[2];
        if (isNaN(low) && isNaN(high)) {
          switch(match[3]) {
            case '=':  low = high = +match[4]; break;
            case '>':  low = +match[4] + 1; high = Infinity; break;
            case '<':  low = 0; high = +match[4] - 1; break;
            case '>=': low = +match[4]; high = Infinity; break;
            case '<=': low = 0; high = +match[4]; break;
          }
        }
        else if (isNaN(high)) {
          high = low;
        }

        return value >= low && value <= high;
      }
    };

    return function(d) {
      for (var field in filters) {
        if (!filters.hasOwnProperty(field)) { continue; }

        var f = filters[field];
        if (functions.hasOwnProperty(f.type) && !functions[f.type].call(f, d[field])) {
          return false;
        }
      }

      return true;
    };
  }

  function sortFunc(sort) {
    // Sorting functions leave undefined values at end
    var functions = {
        asc: function(a, b) {
          return a === undefined
            ? b === undefined ?  0 : 1
            : b === undefined ? -1 : d3.ascending(a, b)
          ;
        },
        desc: function(a, b) {
          return a === undefined
            ? b === undefined ?  0 : 1
            : b === undefined ? -1 : d3.descending(a, b)
          ;
        }
      },
      s = functions[sort.mode || 'asc'],
      field = sort.field;

    return function(a, b) { return s(a[field], b[field]); };
  }

  function formatDuration(str) {
    function pad(value) {
      return value < 10 ? '0' + value : '' + value;
    }

    // Very limited support only time subset of ISO8601
    return str.replace(/^PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?$/, function(date, hour, minute, second) {
      hour = +hour || 0;
      minute = +minute || 0;
      second = +second || 0;

      var result = [];
      if (hour > 0) { result.push('' + hour); }
      if (hour > 0 || minute > 0) { result.push(hour > 0 ? pad(minute) : '' + minute); }
      if (second > 0) { result.push(pad(second)); }

      return result.join(':');
    });
  }

  function parseQueryString(query) {
    var result = {};

    query.replace(/([^?=&]+)(?:=([^&]*))?/g, function(param, key, value) { result[key] = value; });

    return result;
  }

  function saveState(state) {
    localStorage.setItem('state', JSON.stringify({
      date: state.date,
      viewMode: state.viewMode,
      selected: state.selected,
      filters: state.filters,
      sort: state.sort
    }));
  }

  function loadState(defaultState) {
    var state = JSON.parse(localStorage.getItem('state'));

    return {
      date: state ? state.date : (defaultState && defaultState.date || null),
      viewMode: state ? state.viewMode : (defaultState && defaultState.viewMode || null),
      selected: state ? state.selected : (defaultState && defaultState.selected || {}),
      filters: state ? state.filters : (defaultState && defaultState.filters || {}),
      sort: state ? state.sort : (defaultState && defaultState.sort || { field: 'index', mode: null }),
    };
  }

  function table(headers) {
    var values = [],
        selected = {},
        filters = {},
        res = {},
        sortField = null,
        sortMode = null,
        sortModes = [null, 'asc', 'desc'],
        nextSortModeTable = d3.map(),
        viewMode = 'one-line-wide',
        cellTypes = {
          text: function(selection, d) {
            selection.text(d.value);
          },
          html: function(selection, d) {
            selection.html(
              '<span class="text">' + (res[d.code]
                ? d.value.replace(res[d.code], '<span class="filter">$&</span>')
                : d.value
              ) + '</span>'
            );
          },
          bar: function(selection, d) {
            var bar = selection.selectAll('.bar').data([+d.value || 0]),
                value = selection.selectAll('.value').data([+d.value || 0]);

            bar
              .merge(bar.enter().append('div').attr('class', 'bar'))
              .style('width', function(d) { return 5*d + 'px'; });

            value
              .merge(value.enter().append('span').attr('class', 'value'))
              .text(function(d) { return d; });
          }
        },
        listeners = d3.dispatch('filter', 'sort', 'select');

    for (var i = 0, l = sortModes.length; i < l; ++i) {
      nextSortModeTable.set(sortModes[i], sortModes[(i + 1) % l]);
    }

    function tdData(d) {
      return headers.map(function(h) {
        return {
          code: h.code,
          type: h.type || 'text',
          value: d[h.code],
          filterType: h.filter ? h.filter.type : null
        };
      });
    }

    function table(context) {
      var selection = context.selection ? context.selection() : context,
          table = selection.selectAll('.suggestions-table').data([null]),
          tableEnter = table.enter().append('table'),
          tableExit = table.exit();

      tableEnter.append('thead').append('tr');
      tableEnter.append('tbody');

      tableExit.remove();

      table = table.merge(tableEnter)
        .attr('class', 'suggestions-table ' + viewMode)
        .style('table-layout', 'auto')
        .style('width', '');

      table.select('thead > tr').call(tableHeader);
      table.select('tbody').call(tableRow);

      // Special case with ellipsis on overflow: need calculate right columns width
      if (viewMode === 'one-line-screen') {
        var width = 0;
        table.selectAll('thead > tr').each(function(d) {
          var self = d3.select(this);
          var innerWidth = headers
            .filter(function(h) { return h.size === 'fixed'; })
            .map(function(h) { return self.selectAll('.' + h.code).property('offsetWidth'); })
            .reduce(function(accumulator, current) { return accumulator + current; });

          width = Math.max(width, innerWidth);
        });

        width = selection.property('offsetWidth') - width - 16;// 16 for body margin

        table
          .style('table-layout', 'fixed')
          .style('width', '100%');

        var headersWithVariableWidth = headers
          .filter(function(h) { return h.size !== 'fixed'; })
          .map(function(h) { return h.code; });

        if (headersWithVariableWidth.length > 0) {
          width = width / headersWithVariableWidth.length;

          table.selectAll('th').each(function(d) {
            if (headersWithVariableWidth.indexOf(d.code) === -1) { return; }

            d3.select(this).style('width', width + 'px');
          });
        }
      }
    }

    function tableHeader(context) {
      var selection = context.selection ? context.selection() : context,
          th = selection.selectAll('th').data(headers),
          thEnter = th.enter().append('th'),
          thExit = th.exit();

      thEnter
        .each(function(d) {
          var self = d3.select(this);
          self.append('span').attr('class', 'column-name');

          if (!d.filter) { return; }

          self.append('input')
            .attr('type', 'text')
            .attr('value', filters[d.code] && filters[d.code].value)
            .attr('class', d.filter.type)
            .attr('placeholder', d.filter.help)
            .on('keyup.table', function(d) {
              if (this.value === '') {
                delete filters[d.code];
              }
              else {
                filters[d.code] = { field: d.code, type: d.filter.type, value: this.value };
              }

              listeners.call('filter', d, filters);
            });
        })
        .on('click.table', function(d) {
          if (d3.event.target.tagName === 'INPUT') { return; }

          var sortMode = nextSortModeTable.get(sort.field === d.code ? sort.mode : null);
          var sortField = sortMode === null ? null : d.code;

          listeners.call('sort', d, sortField, sortMode);
        });

      thExit.remove();

      th = th.merge(thEnter);
      th
        .attr('class', function(d) { return d.code; })
        .attr('title', function(d) { return d.title; })
        .classed('asc', function(d) { return sort.mode === 'asc' && sort.field === d.code; })
        .classed('desc', function(d) { return sort.mode === 'desc' && sort.field === d.code; })
        .select('.column-name').text(function(d) { return d.name; });
    }

    function tableRow(context) {
      var selection = context.selection ? context.selection() : context,
          tr = selection.selectAll('tr').data(values, function(d) { return d.index; }).order(),
          trEnter = tr.enter().append('tr'),
          trExit = tr.exit();

      trEnter.on('click.table', function(d) { listeners.call('select', d); });

      trExit.remove();

      tr = tr.merge(trEnter);
      tr
        .classed('selected', function(d) { return selected[d.index]; })
        .classed('winner-voters', function (d) { return d.choice === 'voters'; })
        .classed('winner-tom', function (d) { return d.choice === 'tom'; })
        .classed('winner-tkpolls', function (d) { return d.choice === 'tkpolls'; });

      var td = tr.selectAll('td').data(tdData),
          tdEnter = td.enter().append('td'),
          tdExit = td.exit();

      tdExit.remove();

      td = td.merge(tdEnter);
      td
        .attr('class', function(d) { return d.code; })
        .attr('title', function(d) { return d.value; })
        .each(function(d) {
          d3.select(this)
            .call(cellTypes[d.type], d);
        });
    }

    table.on = function() {
      var value = listeners.on.apply(listeners, arguments);
      return value === listeners ? table : value;
    };

    table.viewMode = function(_) {
      return arguments.length ? (viewMode = _, table) : viewMode;
    };

    table.values = function(_) {
      return arguments.length ? (values = _, table) : values;
    };

    table.sort = function(_) {
      return arguments.length ? (sort = _, table) : sort;
    };

    table.filters = function(_) {
      if (arguments.length) {
        filters = _;
        res = {};
        for (var field in filters) {
          if (!filters.hasOwnProperty(field)) { continue; }

          var f = filters[field];
          if (f.type === 'text') {
            res[field] = new RegExp(f.value, 'ig');
          }
        }

        return table;
      }

      return filters;
    };

    table.selected = function(_) {
      return arguments.length ? (selected = _ || {}, table) : selected;
    };

    return table;
  }

  var state;
  var query;
  var headers = [
    { name: 'Suggestion text', code: 'suggestion', type: 'html', filter: { type: 'text', help: 'Case-insensitive JavaScript RegExp syntax' } },
    { name: '!', title: 'Winner position', code: 'position', size: 'fixed' },
    { name: '#', title: 'Position in omnipoll', code: 'index', size: 'fixed' },
    { name: 'Votes count', code: 'votes', type: 'bar', size: 'fixed', filter: { type: 'number', help: '(=|>|<|>=|<=)?<num> | <low>-<high>' } }
  ];

  var viewModes = [
    { name: 'By one wide line', code: 'one-line-wide' },
    { name: 'By one line with ellipsis on overflow', code: 'one-line-screen' },
    { name: 'With word wrapping', code: 'multiline' }
  ];

  var dataTable;
  var dispatch = d3.dispatch('init', 'load', 'update');

  // Init date selector
  dispatch.on('init.sketch-date', function() {
    // Init select
    var select = d3.select('#sketch-date');
    select.on('change', function() {
      var date = this.value;
      d3.json('data/votes-' + date + '.json', function(error, json) {
        if (error) { throw error; }

        json.data = json.data.map(function(d, i) {
          d.index = i + 1;
          d.my = !!(state.selected[json.date] || {})[d.index];
          return d;
        });

        state.date = json.date;
        state.data = state.data || {};
        state.data[state.date] = json;

        dispatch.call('load');
      });
    });

    // Update select value with ``date`` query param
    if (query.date) {
      var selectNode = select.node();
      var validDates = Array.prototype.map.call(selectNode.options, function(d) { return d.value; });

      if (validDates.indexOf(query.date) !== -1) {
        selectNode.value = query.date;
      }
    }

    select.dispatch('change', {});
  });

  // Init view mode selector
  dispatch.on('init.view-mode', function() {
    var select = d3.select('#view-mode');

    select.selectAll('option').data(viewModes)
      .enter().append('option')
        .text(function(d) { return d.name; })
        .attr('value', function(d) { return d.code; })
        .property('selected', function(d) { return d.code === state.viewMode; });

    select.on('change', function() {
      state.viewMode = this.value;

      dispatch.call('update');
    });

    // Update select value with ``viewMode`` query param
    if (query.viewMode) {
      var selectNode = select.node();

      if (viewModes.map(function(d) { return d.code; }).indexOf(query.viewMode) !== -1) {
        selectNode.value = query.viewMode;
      }
    }

    select.dispatch('change', {});
  });

  // Init table
  dispatch.on('init.table', function() {
    dataTable = table(headers)
      .on('filter', function(filters) {
        state.filters = filters;

        dispatch.call('update');
      })
      .on('sort', function(field, mode) {
        state.sort = { field: field === null ? 'index' : field, mode: mode };

        dispatch.call('update');
      })
      .on('select', function() {
        var selected = state.selected = state.selected || {};
        var selectedDate = selected[state.date] = selected[state.date] || {};
        selectedDate[this.index] = !selectedDate[this.index];

        dispatch.call('update');
      });
  });

  // Load data
  dispatch.on('load.data', function() {
    if (!state.data) { return; }

    var data = state.data[state.date];
    d3.selectAll('span.date').text(data.date);
    d3.select('#patreon-link').attr('href', data.patreon_link);
    d3.select('#video-link-full').attr('href', data.youtube_full_link);
    d3.select('#video-duration-full').text(formatDuration(data.youtube_full_duration));
    d3.select('#video-link-short').attr('href', data.youtube_short_link);
    d3.select('#video-duration-short').text(formatDuration(data.youtube_short_duration));
    d3.select('#comment').text(data.comment);

    dispatch.call('update');
  });

  // Filter, sort and render table data
  dispatch.on('update.data', function() {
    if (!state.data) { return; }

    var data = state.data[state.date].data;

    // Filter data
    data = data.filter(filterFunc(state.filters));

    // Sort data
    data.sort(sortFunc(state.sort));

    // Render data
    dataTable
      .viewMode(state.viewMode)
      .values(data)
      .sort(state.sort)
      .filters(state.filters)
      .selected(state.selected[state.date])
    ;

    d3.select('body').call(dataTable);
  });

  window.onresize = function() {
    d3.select('body').call(dataTable);
  };

  window.onbeforeunload = function(e) {
    saveState(state);
  };

  // Load settings from past session
  state = loadState({
    sort: { field: 'votes', mode: 'desc' },
    viewMode: 'one-line-wide'
  });

  // Parse query string
  query = parseQueryString(location.search);

  dispatch.call('init');
  </script>
</body>
</html>
