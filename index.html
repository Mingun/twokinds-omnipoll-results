<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Twokinds Omnipoll Results</title>
  <style>
  @font-face {
    font-family: 'Fira Sans';
    src: url('fonts/FiraSans-UltraLight.woff2') format('woff2'),
         url('fonts/FiraSans-UltraLight.woff') format('woff');
    font-weight: 200;
    font-style: normal;
  }

  @font-face {
    font-family: 'Fira Sans';
    src: url('fonts/FiraSans-Regular.woff2') format('woff2'),
         url('fonts/FiraSans-Regular.woff') format('woff');
    font-weight: 400;
    font-style: normal;
  }

  @font-face {
    font-family: 'Fira Sans';
    src: url('fonts/FiraSans-Medium.woff2') format('woff2'),
         url('fonts/FiraSans-Medium.woff') format('woff');
    font-weight: 500;
    font-style: normal;
  }

  @font-face {
    font-family: 'Fira Mono';
    src: url('fonts/FiraMono-Regular.woff2') format('woff2'),
         url('fonts/FiraMono-Regular.woff') format('woff');
    font-weight: 400;
    font-style: normal;
  }

  body, input, select, option { font-family: "Fira Sans", sans-serif; }
  body { background: #ceffef; font-weight: 400; }
  h1 { font-size: 1.6em; font-weight: 200; }
  p { margin: 5px 0; }
  code { font-family: "Fira Mono", monospace; }
  .legend-mark {
    display: inline-block;
    margin: 0 5px;
    width: 20px;
    height: 20px;
    border-radius: 10px;
    vertical-align: bottom;
  }

  #controls > div { display: inline-block; margin: 0 4px; }
  #controls > div:first-child { margin-left: 0; }
  #controls > div:last-child { margin-right: 0; }

  table { margin: 20px auto; border-collapse: collapse; white-space: nowrap; }
  th { border-bottom: 2px solid #000000; font-weight: 500; }
  th, td { padding: 2px 5px; }
  td { height: 2.6em; }

  th::after {
    display: inline-block;
    content: "";
    margin-left: 5px;
    border: 5px solid transparent;
    width: 0;
    height: 0;
    vertical-align: middle;
  }
  .asc::after { margin-top: 2px; margin-bottom: 5px; border-top: 0; border-bottom: 8px solid #000000; }
  .desc::after { margin-top: 4px; margin-bottom: 3px; border-top: 8px solid #000000; border-bottom: 0; }
  th > input { margin-left: 5px; padding: 4px; border: 1px solid #d0d0d0; border-radius: 2px; width: 300px; }
  th > input:focus, th > input:hover { border-color: #d86316; box-shadow: inset 0 0 0 1px #d86316; }

  .selected { background-color: #eded91; }

  .suggestion, .position, .index { text-align: right; }
  .position { width: 20px; }
  .index { width: 30px; }
  .votes { text-align: left; }

  .bar {
    display: inline-block;
    margin-right: 5px;
    border-left: 1px solid #000000;
    height: 2em;
    max-height: 19px;
    vertical-align: top;
  }

  .bar, .legend-mark { background-color: #f79646; }
  .winner-voters .bar, .legend-mark.winner-voters { background-color: #1dafe3; }
  .winner-tom .bar, .legend-mark.winner-tom { background-color: #fff545; }
  .winner-tkpolls .bar, .legend-mark.winner-tkpolls { background-color: #c6697a; }
  .filter { background-color: yellow; }

  tbody > tr:hover { background-color: #d86316; color: #ffffff; }
  tbody > tr:hover .bar { background-color: #fbbc79; }
  tbody > tr:hover .filter { color: #000000; }
  tbody > tr.winner-voters:hover .bar { background-color: #20c4ff; }
  tbody > tr.winner-tom:hover .bar { background-color: #ffff90; }
  tbody > tr.winner-tkpolls:hover .bar { background-color: #ff99ab; }
  .lang-secondary { font-size: 0.9em; font-weight: 300; }

  .wrapper { display: flex; align-items: center; }
  .wrapper-icons { flex: 1 1 auto; }
  .wrapper-suggestions { flex: 0 1 auto; }
  .one-line-screen .wrapper-suggestions,
  .one-line-screen .lang-primary,
  .one-line-screen .lang-secondary { overflow: hidden; }

  .one-line-wide .lang-primary, .one-line-wide .lang-secondary { white-space: nowrap; }
  .one-line-screen .lang-primary, .one-line-screen .lang-secondary { white-space: nowrap; text-overflow: ellipsis; }
  .multiline .lang-primary, .multiline .lang-secondary { white-space: normal; }

  .done-icon { display: inline-block; margin: 3px; width: 30px; height: 30px; background-position: center; background-size: contain; }
  .done-icon.type-sketch.site-patreon { background-image: url(images/patreon-sketch.svg); }
  .done-icon.type-sketch.site-deviantart { background-image: url(images/deviantart-sketch.svg); }
  .done-icon.type-sketch.site-twitter { background-image: url(images/twitter-sketch.svg); }
  .done-icon.type-color.site-patreon { background-image: url(images/patreon-color.svg); }
  .done-icon.type-color.site-deviantart { background-image: url(images/deviantart-color.svg); }
  .done-icon.type-color.site-twitter { background-image: url(images/twitter-color.svg); }
  tbody > tr:hover .done-icon.type-sketch.site-patreon { background-image: url(images/patreon-sketch-hover.svg); }
  tbody > tr:hover .done-icon.type-sketch.site-deviantart { background-image: url(images/deviantart-sketch-hover.svg); }
  tbody > tr:hover .done-icon.type-sketch.site-twitter { background-image: url(images/twitter-sketch-hover.svg); }
  tbody > tr:hover .done-icon.type-color.site-patreon { background-image: url(images/patreon-color-hover.svg); }
  tbody > tr:hover .done-icon.type-color.site-deviantart { background-image: url(images/deviantart-color-hover.svg); }
  tbody > tr:hover .done-icon.type-color.site-twitter { background-image: url(images/twitter-color-hover.svg); }
  </style>
  <script src="js/d3.4.13.0.min.js"></script>
</head>
<body>
  <div id="controls"></div>
  <header></header>
  <div id="table-container"></div>
  <script>
  var DEFAULT_LANGUAGE = 'en';
  var languages = {
    'en': {
      'en': 'English',
      'ru': 'Russian',
      'title': 'Twokinds {date} Omnipoll Results',
      'sketch-date': 'Sketch date',
      'view-mode': 'View mode',
      'view-mode-one-line-wide': 'By one wide line',
      'view-mode-one-line-screen': 'By one line with ellipsis on overflow',
      'view-mode-multiline': 'With word wrapping',
      'interface-language': 'Interface language',
      'data-language': 'Data language',
      'data-language-mode': 'Data language mode',
      'data-language-mode-only': 'Only selected',
      'data-language-mode-primary': 'Selected primary, default secondary',
      'data-language-mode-secondary': 'Default primary, selected secondary',
      'header': '<h1>Twokinds {date} Omnipoll Results</h1>'
              + '<p>This is omnipoll results for <a href="{patreon_link}">Twokinds Sketch Stream</a> from {date}. '
              + '(Unofficial) archive record of stream can be viewed on YouTube: '
              + '<a href="{youtube_full_link}">full-length record of stream ({youtube_full_duration})</a> or '
              + '<a href="{youtube_short_link}">shorter x20 speed up version ({youtube_short_duration})</a>.</p>'
              + '<p>{comment}</p>'
              + '<p>Click on table header to toggle column sort mode (ascending, descending or none).</p>'
              + '<p>Click on row to toggle <span class="selected">highlight</span> you choice.</p>'
              + '<p>Filter on suggestion text support syntax <a href="https://developer.mozilla.org/docs/Web/JavaScript/Guide/Regular_Expressions">JavaScript Regular Expression</a>. '
              + 'Matched text in suggestion text <span class="filter">highlighted</span>.</p>'
              + '<p>Filter on votes count may be one number, optionally prefixed with <code>=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code> or <code>&gt;=</code> '
              + 'to filter on exact match, less than, less or equal than, greatest than or greatest or equal than respectively; without prefixes used filter on exact match. '
              + 'Also it may consist of two numbers, delimited by minus sign (<code>-</code>), defining a closed (with included borders) range to match.</p>'
              + '<p>Bar color legend: '
              + '<span class="legend-mark"></span> – ordinal suggestions '
              + '<span class="legend-mark winner-voters"></span> – top votes '
              + '<span class="legend-mark winner-tom"></span> – Tom picks '
              + '<span class="legend-mark winner-tkpolls"></span> – votes from <a href="https://tkpolls.com/results">tkpolls.com</a></p>',
      'table-suggestion': 'Suggestion text',
      'table-suggestion-filter': 'Case-insensitive JavaScript RegExp syntax',
      'table-position': '!',
      'table-position-title': 'Winner position',
      'table-index': '#',
      'table-index-title': 'Position in omnipoll',
      'table-votes': 'Votes count',
      'table-votes-filter': '(=|>|<|>=|<=)?<num> | <low>-<high>',
      'table-icons-sketch': 'Sketch',
      'table-icons-color': 'Colored version',
      'table-icons-published-date': 'Published',
      'table-icons-published-site': 'Site',
      'table-icons-published-site-patreon': 'Patreon',
      'table-icons-published-site-deviantart': 'DeviantArt',
      'table-icons-published-site-twitter': 'Twitter',
      'table-icons-suggested-by': 'Suggested by',
      'table-icons-sponsored-by': 'Sponsored by',
      'table-icons-color-vote-position': 'Position in color vote'
    },
    'ru': {
      'en': 'Английский',
      'ru': 'Русский',
      'title': 'Результаты за {date} всеобщего голосования по Twokinds',
      'sketch-date': 'Дата наброска',
      'view-mode': 'Режим просмотра',
      'view-mode-one-line-wide': 'Одной широкой строкой',
      'view-mode-one-line-screen': 'Одной строкой с многоточием при переполнении',
      'view-mode-multiline': 'С переносом по словам',
      'interface-language': 'Язык интерфейса',
      'data-language': 'Язык данных',
      'data-language-mode': 'Режим языка данных',
      'data-language-mode-only': 'Только выбранный',
      'data-language-mode-primary': 'Выбранный основной, умолчательный дополнительный',
      'data-language-mode-secondary': 'Умолчательный основной, выбранный дополнительный',
      'header': '<h1>Результаты за {date} всеобщего голосования по Twokinds</h1>'
              + '<p>Это результаты всеобщего голосования для <a href="{patreon_link}">трансляции набросков Twokinds</a> от {date}. '
              + '(Неофициальную) архивную запись трансляции можно посмотреть на YouTube: '
              + '<a href="{youtube_full_link}">полноразмерную запись трансляции ({youtube_full_duration})</a> или '
              + '<a href="{youtube_short_link}">её версию, ускоренную в 20 раз ({youtube_short_duration})</a>.</p>'
              + '<p>{comment}</p>'
              + '<p>Нажатие на заголовок таблицы переключает режим сортировки по этой колонке (по возрастанию, по убыванию или никакой).</p>'
              + '<p>Нажатие на строку переключает <span class="selected">подсветку</span> вашего выбора.</p>'
              + '<p>В фильтре по тексту предложения поддерживается синтаксис <a href="https://developer.mozilla.org/docs/ru/Web/JavaScript/Guide/Regular_Expressions">регулярных выражений JavaScript</a>. '
              + 'Найденный текст в тексте предложения <span class="filter">подсвечивается</span>.</p>'
              + '<p>Фильтр по количеству голосов может быть как одним числом, по желанию предварённым символами <code>=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code> или <code>&gt;=</code> '
              + 'для фильтра по точному совпадению, меньше чем, меньше или равно, больше чем или больше или равно соответственно; если префикс не указан, подразумевается точное совпадение. '
              + 'Также фильтр может состоять из двух чисел, разделённых знаком минуса (<code>-</code>), в этом случае он определяет закрытый (с включением его границ) диапазон для соответствия.</p>'
              + '<p>Легенда по цветам гистограммы: '
              + '<span class="legend-mark"></span> – обычное предложение '
              + '<span class="legend-mark winner-voters"></span> – выбор большинством голосов '
              + '<span class="legend-mark winner-tom"></span> – выбор Тома '
              + '<span class="legend-mark winner-tkpolls"></span> – выбор голосованием на <a href="https://tkpolls.com/results">tkpolls.com</a></p>',
      'table-suggestion': 'Текст предложения',
      'table-suggestion-filter': 'Регулярное выражение JavaScript',
      'table-position': '!',
      'table-position-title': 'Позиция победителя',
      'table-index': '#',
      'table-index-title': 'Позиция в голосовании',
      'table-votes': 'Количество голосов',
      'table-votes-filter': '(=|>|<|>=|<=)?<число> | <мин>-<макс>',
      'table-icons-sketch': 'Набросок',
      'table-icons-color': 'Цветная версия',
      'table-icons-published-date': 'Опубликована',
      'table-icons-published-site': 'Площадка',
      'table-icons-published-site-patreon': 'Patreon',
      'table-icons-published-site-deviantart': 'DeviantArt',
      'table-icons-published-site-twitter': 'Твиттер',
      'table-icons-suggested-by': 'Предложена',
      'table-icons-sponsored-by': 'Проспонсирована',
      'table-icons-color-vote-position': 'Позиция в голосовании на раскраску'
    }
  };
  </script>
  <script>
  function filterFunc(filters) {
    var functions = {
      text: function(value) {
        var regexp = new RegExp(this.value, 'ig');
        for (var lang in value) {
          if (value.hasOwnProperty(lang) && regexp.test(value[lang])) {
            return true;
          }
        }

        return false;
      },
      number: function(value) {
        var testValue = this.value.replace(/\s+/g, '');
        var match = /^(?:(\d+)(?:-(\d+))?|(=|>|<|>=|<=)(\d+))$/i.exec(testValue);
        if (match === null) { return false; }

        var low = +match[1];
        var high = +match[2];
        if (isNaN(low) && isNaN(high)) {
          switch(match[3]) {
            case '=':  low = high = +match[4]; break;
            case '>':  low = +match[4] + 1; high = Infinity; break;
            case '<':  low = 0; high = +match[4] - 1; break;
            case '>=': low = +match[4]; high = Infinity; break;
            case '<=': low = 0; high = +match[4]; break;
          }
        }
        else if (isNaN(high)) {
          high = low;
        }

        return value >= low && value <= high;
      }
    };

    return function(d) {
      for (var field in filters) {
        if (!filters.hasOwnProperty(field)) { continue; }

        var f = filters[field];
        if (functions.hasOwnProperty(f.type) && !functions[f.type].call(f, d[field])) {
          return false;
        }
      }

      return true;
    };
  }

  function sortFunc(sort) {
    // Sorting functions leave undefined values at end
    var functions = {
        asc: function(a, b) {
          return a === undefined
            ? b === undefined ?  0 : 1
            : b === undefined ? -1 : d3.ascending(a, b)
          ;
        },
        desc: function(a, b) {
          return a === undefined
            ? b === undefined ?  0 : 1
            : b === undefined ? -1 : d3.descending(a, b)
          ;
        }
      },
      s = functions[sort.mode || 'asc'],
      field = sort.field;

    return function(a, b) { return s(a[field], b[field]); };
  }

  function template(template, parameters) {
    return template.replace(/\{([\w\d-_]+)\}/g, function(match, param) {
      return parameters[param];
    });
  }

  function formatDuration(str) {
    function pad(value) {
      return value < 10 ? '0' + value : '' + value;
    }

    // Very limited support only time subset of ISO8601
    return str.replace(/^PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?$/, function(date, hour, minute, second) {
      hour = +hour || 0;
      minute = +minute || 0;
      second = +second || 0;

      var result = [];
      if (hour > 0) { result.push('' + hour); }
      if (hour > 0 || minute > 0) { result.push(hour > 0 ? pad(minute) : '' + minute); }
      if (second > 0) { result.push(pad(second)); }

      return result.join(':');
    });
  }

  function parseQueryString(queryString) {
    var result = {};
    var re = /([^?=&]+)(?:=([^&]*))?/g;
    var match;
    while ((match = re.exec(queryString)) !== null) {
      result[match[1]] = match[2];
    }

    return result;
  }

  function saveState(state) {
    localStorage.setItem('state', JSON.stringify({
      date: state.date,
      viewMode: state.viewMode,
      interfaceLanguage: state.interfaceLanguage,
      dataLanguage: state.dataLanguage,
      dataLanguageMode: state.dataLanguageMode,
      selected: state.selected,
      filters: state.filters,
      sort: state.sort
    }));
  }

  function loadState(before, after) {
    var state = JSON.parse(localStorage.getItem('state'));
    var states = [before, state, after].filter(function(s) { return !!s; });

    function get(field, defaultValue) {
      for (var i = 0; i < states.length; ++i) {
        var value = states[i][field];
        if (typeof value !== 'undefined') {
          return value;
        }
      }

      return defaultValue;
    }

    return {
      date: get('date', null),
      viewMode: get('viewMode', null),
      interfaceLanguage: get('interfaceLanguage', DEFAULT_LANGUAGE),
      dataLanguage: get('dataLanguage', DEFAULT_LANGUAGE),
      dataLanguageMode: get('dataLanguageMode', null),
      selected: get('selected', {}),
      filters: get('filters', {}),
      sort: get('sort', { field: 'index', mode: null })
    };
  }

  function loadData(date, language) {
    d3.json('data/votes-' + date + '.json', function(error, json) {
      if (error) { throw error; }

      json.data = json.data.map(function(d, i) {
        d.index = i + 1;
        d.my = !!(state.selected[json.date] || {})[d.index];

        var suggestion = d.suggestion;
        d.suggestion = {
          suggesions: {},
          suggested_by: d.suggested_by || [],
          sponsored_by: d.suggested_by || [],
          color_position: d.color_position,
          links: d.links || []
        };
        d.suggestion.suggesions[DEFAULT_LANGUAGE] = suggestion;

        for (var i = 0; i < d.suggestion.links.length; ++i) {
          var link = d.suggestion.links[i];
          var name = link.name;
          link.name = {};
          link.name[DEFAULT_LANGUAGE] = name;
        }

        return d;
      });

      var comment = json.comment;
      json.comment = {};
      json.comment[DEFAULT_LANGUAGE] = comment;

      state.date = json.date;
      state.data = state.data || {};
      state.data[state.date] = json;

      loadLanguage(state.date, language);
    });
  }

  function loadLanguage(date, language) {
    if (!state.data) { return; }

    if (language === DEFAULT_LANGUAGE) {
      state.dataLanguage = language;

      dispatch.call('load');

      return;
    }

    var amount = 2, i = 0;
    function allLoaded() {
      ++i;
      if (amount === i) {
        i = 0;
        dispatch.call('load');
      }
    }

    d3.json('data/' + language + '/votes-' + date + '.json', function(error, json) {
      if (error) { throw error; }

      var data = state.data[state.date].data;
      for (var i = 0; i < data.length; ++i) {
        data[i].suggestion.suggesions[json.language] = json.suggestions[i];
      }

      var comment = state.data[state.date].comment;
      if (comment) {
        comment[json.language] = json.comment;
      }

      state.dataLanguage = json.language;

      allLoaded();
    });

    d3.json('data/' + language + '/additional.json', function(error, json) {
      if (error) { throw error; }

      var data = state.data[state.date].data;
      for (var i = 0; i < data.length; ++i) {
        var links = data[i].suggestion.links;
        for (var j = 0; j < links.length; ++j) {
          links[j].name[json.language] = json.publish_name[links[j].name[DEFAULT_LANGUAGE]];
        }
      }

      allLoaded();
    });
  }

  function select(id, name, codes, values) {
    var selected = null,
        listeners = d3.dispatch('select');

    function select(context) {
      var selection = context.selection ? context.selection() : context,
          control = selection.selectAll('.' + id).data([null]),
          controlEnter = control.enter().append('div').attr('class', id),
          controlExit = control.exit();

      controlEnter.append('label')
        .attr('for', id);
      controlEnter.append('select')
        .attr('id', id)
        .on('change', function() {
          listeners.call('select', {
            code: this.value,
            name: values && values[codes.indexOf(this.value)] || this.value
          });
        });

      controlExit.remove();

      control = control.merge(controlEnter);

      control.select('label').text(name + ': ');

      var data = codes.map(function(d, i) { return { name: values && values[i] || d, code: d }; }),
          options = control.select('select').selectAll('option').data(data),
          optionsEnter = options.enter().append('option'),
          optionsExit = options.exit();

      optionsExit.remove();

      options = options.merge(optionsEnter)
        .text(function(d) { return d.name; })
        .attr('value', function(d) { return d.code; })
        .property('selected', function(d) { return d.code === selected; });
    }

    select.on = function() {
      var value = listeners.on.apply(listeners, arguments);
      return value === listeners ? select : value;
    };

    select.codes = function(_) {
      return arguments.length ? (codes = _, select) : codes;
    };

    select.values = function(_) {
      return arguments.length ? (values = _, select) : values;
    };

    select.selected = function(_) {
      return arguments.length ? (selected = _, select) : selected;
    };

    return select;
  }

  function table(headers, interfaceLanguagesData) {
    var values = [],
        selected = {},
        filters = {},
        res = {},
        sortField = null,
        sortMode = null,
        sortModes = [null, 'asc', 'desc'],
        nextSortModeTable = d3.map(),
        viewMode = 'one-line-wide',
        languages = ['en'],
        languagesData = [{ lang: 'en', type: 'primary' }],
        cellTypes = {
          text: function(selection, d) {
            selection.text(d.value);
          },
          html: function(selection, d) {
            var wrapper = selection.selectAll('.wrapper').data([null]),
                wrapperEnter = wrapper.enter().append('div').attr('class', 'wrapper'),
                wrapperExit = wrapper.exit().remove();

            wrapper = wrapper.merge(wrapperEnter);

            var links = d.value.links;
            var wrapperIcons = wrapper.selectAll('.wrapper-icons').data([null]),
                wrapperIconsEnter = wrapperIcons.enter().append('div').attr('class', 'wrapper-icons'),
                wrapperIconsExit = wrapperIcons.exit().remove();

            wrapperIcons = wrapperIcons.merge(wrapperIconsEnter);

            var icons = wrapperIcons.selectAll('a').data(links),
                iconsEnter = icons.enter().append('a'),
                iconsExit = icons.exit();

            icons
              .merge(iconsEnter)
              .attr('href', function(l) { return l.link; })
              .attr('class', function(l) { return 'done-icon site-' + l.site + ' type-' + l.type; })
              .attr('title', function(l) {
                return languagesData.map(function(k) { return l.name[k.lang]; }).filter(function(d) { return d; }).join('\n')
                     + '\n\n' + interfaceLanguagesData['table-icons-' + l.type]
                     + '\n\n' + interfaceLanguagesData['table-icons-published-date'] + ': ' + l.date
                     + '\n' + interfaceLanguagesData['table-icons-published-site'] + ': '
                     + interfaceLanguagesData['table-icons-published-site-' + l.site]
                     + '\n' + interfaceLanguagesData['table-icons-suggested-by'] + ': ' + d.value.suggested_by.join(', ')
                     + (l.sponsored_by ? '\n' + interfaceLanguagesData['table-icons-sponsored-by'] + ': ' + l.sponsored_by.join(', ') : '')
                     + (d.value.color_posision ? '\n' + interfaceLanguagesData['table-icons-color-vote-position'] + ': ' + d.value.color_posision : '');
              });

            iconsExit.remove();

            var suggesions = d.value.suggesions;
            var wrapperSuggesions = wrapper.selectAll('.wrapper-suggestions').data([null]),
                wrapperSuggesionsEnter = wrapperSuggesions.enter().append('div').attr('class', 'wrapper-suggestions'),
                wrapperSuggesionsExit = wrapperSuggesions.exit().remove();

            wrapperSuggesions = wrapperSuggesions.merge(wrapperSuggesionsEnter);

            var lang = wrapperSuggesions.selectAll('div').data(languagesData).order(),
                langEnter = lang.enter().append('div'),
                langExit = lang.exit();

            lang
              .merge(langEnter)
              .attr('class', function(l) { return 'lang-' + l.lang + ' lang-' + l.type; })
              .attr('title', function(l) { return suggesions[l.lang]; })
              .html(function(l) {
                return res[d.code]
                  ? suggesions[l.lang].replace(res[d.code], '<span class="filter">$&</span>')
                  : suggesions[l.lang];
              });

            langExit.remove();
          },
          bar: function(selection, d) {
            var bar = selection.selectAll('.bar').data([+d.value || 0]),
                value = selection.selectAll('.value').data([+d.value || 0]);

            bar
              .merge(bar.enter().append('div').attr('class', 'bar'))
              .attr('title', function(d) { return d; })
              .style('width', function(d) { return 5*d + 'px'; });

            value
              .merge(value.enter().append('span').attr('class', 'value'))
              .attr('title', function(d) { return d; })
              .text(function(d) { return d; });
          }
        },
        listeners = d3.dispatch('filter', 'sort', 'select');

    for (var i = 0, l = sortModes.length; i < l; ++i) {
      nextSortModeTable.set(sortModes[i], sortModes[(i + 1) % l]);
    }

    function tdData(d) {
      return headers.map(function(h) {
        return {
          code: h.code,
          type: h.type || 'text',
          value: d[h.code],
          filterType: h.filter ? h.filter.type : null
        };
      });
    }

    function table(context) {
      var selection = context.selection ? context.selection() : context,
          table = selection.selectAll('.suggestions-table').data([null]),
          tableEnter = table.enter().append('table'),
          tableExit = table.exit();

      tableEnter.append('thead').append('tr');
      tableEnter.append('tbody');

      tableExit.remove();

      table = table.merge(tableEnter)
        .attr('class', 'suggestions-table ' + viewMode)
        .style('table-layout', 'auto')
        .style('width', '');

      table.select('thead > tr').call(tableHeader);
      table.select('tbody').call(tableRow);

      // Special case with ellipsis on overflow: need calculate right columns width
      if (viewMode === 'one-line-screen') {
        var width = 0;
        table.selectAll('thead > tr').each(function(d) {
          var self = d3.select(this);
          var innerWidth = headers
            .filter(function(h) { return h.size === 'fixed'; })
            .map(function(h) { return self.selectAll('.' + h.code).property('offsetWidth'); })
            .reduce(function(accumulator, current) { return accumulator + current; });

          width = Math.max(width, innerWidth);
        });

        width = selection.property('offsetWidth') - width - 16;// 16 for body margin

        table
          .style('table-layout', 'fixed')
          .style('width', '100%');

        var headersWithVariableWidth = headers
          .filter(function(h) { return h.size !== 'fixed'; })
          .map(function(h) { return h.code; });

        if (headersWithVariableWidth.length > 0) {
          width = width / headersWithVariableWidth.length;

          table.selectAll('th').each(function(d) {
            if (headersWithVariableWidth.indexOf(d.code) === -1) { return; }

            d3.select(this).style('width', width + 'px');
          });
        }
      }
    }

    function tableHeader(context) {
      var selection = context.selection ? context.selection() : context,
          th = selection.selectAll('th').data(headers),
          thEnter = th.enter().append('th'),
          thExit = th.exit();

      thEnter
        .each(function(d) {
          var self = d3.select(this);
          self.append('span').attr('class', 'column-name');

          if (!d.filter) { return; }

          self.append('input')
            .attr('type', 'text')
            .attr('value', filters[d.code] && filters[d.code].value)
            .attr('class', d.filter.type)
            .on('keyup.table', function(d) {
              if (this.value === '') {
                delete filters[d.code];
              }
              else {
                filters[d.code] = { field: d.code, type: d.filter.type, value: this.value };
              }

              listeners.call('filter', d, filters);
            });
        })
        .on('click.table', function(d) {
          if (d3.event.target.tagName === 'INPUT') { return; }

          var sortMode = nextSortModeTable.get(sort.field === d.code ? sort.mode : null);
          var sortField = sortMode === null ? null : d.code;

          listeners.call('sort', d, sortField, sortMode);
        });

      thExit.remove();

      th = th.merge(thEnter);
      th
        .attr('class', function(d) { return d.code; })
        .attr('title', function(d) { return d.title; })
        .classed('asc', function(d) { return sort.mode === 'asc' && sort.field === d.code; })
        .classed('desc', function(d) { return sort.mode === 'desc' && sort.field === d.code; });
      th.select('.column-name').text(function(d) { return d.name; });
      th.select('input').attr('placeholder', function(d) { return d.filter.help; });

    }

    function tableRow(context) {
      var selection = context.selection ? context.selection() : context,
          tr = selection.selectAll('tr').data(values, function(d) { return d.index; }).order(),
          trEnter = tr.enter().append('tr'),
          trExit = tr.exit();

      trEnter.on('click.table', function(d) { listeners.call('select', d); });

      trExit.remove();

      tr = tr.merge(trEnter);
      tr
        .classed('selected', function(d) { return selected[d.index]; })
        .classed('winner-voters', function (d) { return d.choice === 'voters'; })
        .classed('winner-tom', function (d) { return d.choice === 'tom'; })
        .classed('winner-tkpolls', function (d) { return d.choice === 'tkpolls'; });

      var td = tr.selectAll('td').data(tdData),
          tdEnter = td.enter().append('td'),
          tdExit = td.exit();

      tdExit.remove();

      td = td.merge(tdEnter);
      td
        .attr('class', function(d) { return d.code; })
        .each(function(d) {
          d3.select(this)
            .call(cellTypes[d.type], d);
        });
    }

    table.on = function() {
      var value = listeners.on.apply(listeners, arguments);
      return value === listeners ? table : value;
    };

    table.viewMode = function(_) {
      return arguments.length ? (viewMode = _, table) : viewMode;
    };

    table.values = function(_) {
      return arguments.length ? (values = _, table) : values;
    };

    table.languages = function(_) {
      if (arguments.length) {
        languages = _;
        languagesData = [];
        for (var i = 0; i < languages.length && i < 2; ++i) {
          languagesData.push({ lang: languages[i], type: i === 0 ? 'primary' : 'secondary' });
        }

        return table;
      }

      return languages;
    };

    table.sort = function(_) {
      return arguments.length ? (sort = _, table) : sort;
    };

    table.filters = function(_) {
      if (arguments.length) {
        filters = _;
        res = {};
        for (var field in filters) {
          if (!filters.hasOwnProperty(field)) { continue; }

          var f = filters[field];
          if (f.type === 'text') {
            res[field] = new RegExp(f.value, 'ig');
          }
        }

        return table;
      }

      return filters;
    };

    table.selected = function(_) {
      return arguments.length ? (selected = _ || {}, table) : selected;
    };

    return table;
  }

  var state;
  var dates = [
    '2020-03-08',
    '2020-02-10',
    '2019-12-22',
    '2019-10-20',
    '2019-09-15',
    '2019-08-25',
    '2019-08-11',
    '2019-08-04',
    '2019-06-16',
    '2019-06-09',
    '2019-06-02',
    '2019-05-19'
  ];
  var headers = [
    { code: 'suggestion', type: 'html', filter: { type: 'text' } },
    { code: 'position', size: 'fixed' },
    { code: 'index', size: 'fixed' },
    { code: 'votes', type: 'bar', size: 'fixed', filter: { type: 'number' } }
  ];

  var dataTable;
  var dispatch = d3.dispatch('init', 'load', 'update');

  // Init date selector
  dispatch.on('init.sketch-date', function() {
    var selector = select('sketch-date', languages[state.interfaceLanguage]['sketch-date'], dates);
    selector
      .selected(state.date)
      .on('select', function() {
        state.requestedDate = this.code;

        // Use setTimeout to enforce filling state.requestedDataLanguage
        setTimeout(function() { loadData(state.requestedDate, state.requestedDataLanguage || state.dataLanguage); }, 0);
      });

    d3.select('#controls').call(selector);

    loadData(state.date, state.dataLanguage);
  });

  // Init view mode selector
  dispatch.on('init.view-mode', function() {
    var language = languages[state.interfaceLanguage];
    var codes = ['one-line-wide', 'one-line-screen', 'multiline'];
    var values = codes.map(function(d) { return language['view-mode-' + d]; });
    var selector = select('view-mode', language['view-mode'], codes, values);
    selector
      .selected(state.viewMode)
      .on('select', function() {
        state.viewMode = this.code;

        dispatch.call('update');
      });

    d3.select('#controls').call(selector);
  });

  // Init interface language selector
  dispatch.on('init.interface-language', function() {
    var language = state.interfaceLanguage;
    var codes = Object.keys(languages);
    var values = codes.map(function(d) { return languages[language][d] + (language !== d ? ' — ' + languages[d][d] : ''); });
    var selector = select('interface-language', languages[language]['interface-language'], codes, values);
    selector
      .selected(language)
      .on('select', function() {
        state.interfaceLanguage = this.code;

        dispatch.call('init');
      });

    d3.select('#controls').call(selector);
  });

  // Init data language selector
  dispatch.on('init.data-language', function() {
    var language = state.interfaceLanguage;
    var codes = Object.keys(languages);
    var values = codes.map(function(d) { return languages[language][d] + (language !== d ? ' — ' + languages[d][d] : ''); });
    var selector = select('data-language', languages[language]['data-language'], codes, values);
    selector
      .selected(state.dataLanguage)
      .on('select', function() {
        state.requestedDataLanguage = this.code;

        // Use setTimeout to enforce filling state.requestedDate
        setTimeout(function() { loadLanguage(state.requestedDate || state.date, state.requestedDataLanguage); }, 0);
      });

    d3.select('#controls').call(selector);

    loadLanguage(state.date, state.dataLanguage);
  });

  // Init data language mode selector
  dispatch.on('init.data-language-mode', function() {
    var language = languages[state.interfaceLanguage];
    var codes = ['only', 'primary', 'secondary'];
    var values = codes.map(function(d) { return language['data-language-mode-' + d]; });
    var selector = select('data-language-mode', language['data-language-mode'], codes, values);
    selector
      .selected(state.dataLanguageMode)
      .on('select', function() {
        state.dataLanguageMode = this.code;

        dispatch.call('update');
      });

    d3.select('#controls').call(selector);
  });

  // Init table
  dispatch.on('init.table', function() {
    var language = languages[state.interfaceLanguage];
    dataTable = table(headers.map(function(d) {
      var h = { name: language['table-' + d.code], code: d.code, type: d.type || 'text' };
      if (d.title) {
        h.title = language['table-' + d.title];
      }
      if (d.size) {
        h.size = d.size;
      }
      if (d.filter) {
        h.filter = { type: d.filter.type, help: language['table-' + d.code + '-filter'] };
      }

      return h;
    }), language)
      .on('filter', function(filters) {
        state.filters = filters;

        dispatch.call('update');
      })
      .on('sort', function(field, mode) {
        state.sort = { field: field === null ? 'index' : field, mode: mode };

        dispatch.call('update');
      })
      .on('select', function() {
        var selected = state.selected = state.selected || {};
        var selectedDate = selected[state.date] = selected[state.date] || {};
        selectedDate[this.index] = !selectedDate[this.index];

        dispatch.call('update');
      });
  });

  // Load data
  dispatch.on('load.data', function() {
    if (!state.data) { return; }

    var data = state.data[state.date];
    var language = languages[state.interfaceLanguage];
    var comment = state.dataLanguage && state.dataLanguage in data.comment
      ? data.comment[state.dataLanguage]
      : data.comment[DEFAULT_LANGUAGE];
    d3.select('title').text(template(language.title, { date: data.date }));
    d3.select('header').html(template(language.header, {
      date: data.date,
      patreon_link: data.patreon_link,
      youtube_full_link: data.youtube_full_link,
      youtube_full_duration: formatDuration(data.youtube_full_duration),
      youtube_short_link: data.youtube_short_link,
      youtube_short_duration: formatDuration(data.youtube_short_duration),
      comment: comment || ''
    }));

    dispatch.call('update');
  });

  // Filter, sort and render table data
  dispatch.on('update.data', function() {
    if (!state.data) { return; }

    // Determinate languages
    var languages = [];
    if (state.dataLanguageMode === 'only' || !state.dataLanguage || state.dataLanguage === DEFAULT_LANGUAGE) {
      languages.push(state.dataLanguage || DEFAULT_LANGUAGE);
    }
    else {
      if (state.dataLanguageMode === 'primary') {
        languages.push(state.dataLanguage);
      }

      languages.push(DEFAULT_LANGUAGE);

      if (state.dataLanguageMode === 'secondary') {
        languages.push(state.dataLanguage);
      }
    }

    var data = state.data[state.date].data;

    // Filter data
    data = data.filter(filterFunc(state.filters));

    // Sort data
    data.sort(sortFunc(state.sort));

    // Render data
    dataTable
      .viewMode(state.viewMode)
      .languages(languages)
      .values(data)
      .sort(state.sort)
      .filters(state.filters)
      .selected(state.selected[state.date])
    ;

    d3.select('#table-container').call(dataTable);
  });

  window.onresize = function() {
    d3.select('#table-container').call(dataTable);
  };

  window.onbeforeunload = function() {
    saveState(state);
  };

  // Parse query string
  var query = parseQueryString(location.search);

  // Load settings from past session
  state = loadState(query, {
    date: dates[0],
    viewMode: 'one-line-wide',
    interfaceLanguage: DEFAULT_LANGUAGE,
    dataLanguage: DEFAULT_LANGUAGE,
    dataLanguageMode: 'primary',
    sort: { field: 'votes', mode: 'desc' }
  });

  dispatch.call('init');
  </script>
</body>
</html>
